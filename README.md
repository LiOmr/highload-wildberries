## Wildberries: Описание проекта

## 1. Тема и целевая аудитория

Wildberries (также «Ва́йлдберриз») — крупнейший маркетплейс в России, специализирующийся на продаже товаров различных категорий, включая одежду, обувь, бытовую технику и электронику, товары для дома, косметику и многое другое [\[1\]](https://ru.ruwiki.ru/wiki/Wildberries). 

### Продуктовые метрики
- 76,7 млн уникальных посетителей в месяц [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- 14 млн уникальных посетителей в день [\[4\]](https://www.retail.ru/news/oborot-wildberries-vyros-na-101-v-iii-kvartale-15-oktyabrya-2021-210183/)
- 41,3 млн активных покупателей в месяц [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- Количество активных* селлеров: 293 700 [\[5\]](https://datainsight.ru/sites/default/files/DI_Sellers_monitoring_2024_1_0.pdf?ysclid=m7px4bgk8r609130117)

- Число ежедневных заказов: 8,8 млн [\[7\]](https://mertech.ru/blog/marketpleisy/kak-otkryt-punkt-vydachi-zakazov-wildberries-v-2024/#:~:text=Wildberries%20%E2%80%94%20%D1%81%D0%B0%D0%BC%D1%8B%D0%B9%20%D0%BF%D0%BE%D0%BF%D1%83%D0%BB%D1%8F%D1%80%D0%BD%D1%8B%D0%B9%20%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9,%D0%BA%D0%BE%D1%82%D0%BE%D1%80%D0%B0%D1%8F%20%D0%BE%D1%82%D0%B2%D0%B5%D1%87%D0%B0%D0%B5%D1%82%20%D0%BD%D0%B0%20%D1%87%D0%B0%D1%81%D1%82%D1%8B%D0%B5%20%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81%D1%8B)

- Среднее число страниц за один визит: 12 [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- Среднее время одного визита: 10 мин [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- Мобильные устройства: 86% [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- Десктоп: 14% [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

- Среднее число товаров в заказе покупателя: сумма среднего чека / средняя цена одного товара = 1 594 [\[6\]](https://plusworld.ru/articles/62655/#:~:text=%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D0%B8%D0%B9%20%D1%87%D0%B5%D0%BA%20%D0%BD%D0%B0%20%D0%BC%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%D0%B0%D1%85%20%D0%B2%D1%8B%D1%80%D0%BE%D1%81,%D0%BE%D0%BD%20%D1%81%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%B8%D0%BB%20793%20%D1%80%D1%83%D0%B1%D0%BB%D1%8F) / 750 = 2,1
- Среднее число товаров на одного селлера: общее количество товарных единиц на Wildberries (SKU) / число активных селлеров = 40 млн [\[9\]](https://workspace.ru/blog/algoritmy-ranzhirovaniya-na-wildberries-kak-oni-rabotayut-i-kak-uluchshit-vidimost-svoih-tovarov/) / 293 700 [\[5\]](https://datainsight.ru/sites/default/files/DI_Sellers_monitoring_2024_1_0.pdf?ysclid=m7px4bgk8r609130117) = 136,2

> *Активные селлеры – селлеры, у которых на момент сбора данных был хотя бы один товар в продаже на маркетплейсе

### Целевая аудитория

**1. Распределение по возрасту** [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

| Возраст     | Доля  |
|-------------|-------|
| < 18 лет    | 1%    |
| 18–25 лет   | 14%   |
| 26–35 лет   | 35%   |
| 36–45 лет   | 34%   |
| 46–60 лет   | 14%   |
| 60+ лет     | 2%    |

**2. Распределение по полу** [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

| Пол       | Доля  |
|-----------|-------|
| Женщины   | 66%   |
| Мужчины   | 34%   |

**3. Распределение по уровню дохода** [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

| Уровень дохода | Доля  |
|----------------|-------|
| Низкий         | 6%    |
| Средний        | 57%   |
| Средний+       | 35%   |
| Высокий        | 2%    |

### Веб-трафик по странам
![image](https://github.com/user-attachments/assets/e15d7d94-e3af-48be-a5a7-2f702621858b) [\[2\]](https://www.similarweb.com/ru/website/wildberries.ru/#overview)

---

### Функционал MVP
**Ключевой функционал** - просмотр ленты товаров

1. Регистрация и авторизация пользователей.  
2. Каталог товаров (возможность добавления и управления товарами – название, описание, цена, фотографии).  
3. Поиск и фильтрация (фильтрация по цене, брендам и другим параметрам).  
4. Корзина и оформление заказа с выбором способа доставки и оплаты.  
5. Онлайн-оплата (минимум один способ онлайн-оплаты, безопасная передача платежных данных).  
6. Доставка (указание адреса доставки/пункта самовывоза, отслеживание статуса заказа).  
7. Личный кабинет покупателя.  
8. Индивидуальные рекомендации товаров на основе:
   - товаров, добавленных в избранное
   - просмотренных пользователем товаров
   - оформленных покупок
   - поисковых запросов
   - региона и геолокации пользователя  
9. Личный кабинет продавца.

---

## 2. Расчет нагрузки

| Характеристика | Значение |
|---------------|----------|
| MAU           | 76,7M    |
| DAU           | 14M      |

---

### 1. Среднее количество действий пользователя в день

| **Действие пользователя**                       | **Количество в день** |
|-------------------------------------------------|-----------------------|
| Просмотр страниц (каталог, карточка товара)     | ~12–13                |
| Поисковые запросы / фильтрация                  | ~2–3                  |
| Добавление в корзину / избранное                | ~1-1,3                |
| Оформление заказа                               | ~0,6                  |
| Прочие действия (личный кабинет, отзывы и т.п.) | 1–2                   |


- **Среднее число просмотренных страниц:** порядка 12 просмотренных товаров в день на одного активного пользователя,[3] Из которых значительная часть – это страницы товаров.
- **Поисковые запросы**: большинство пользователей совершает по 2–3 поисковых/фильтрационных действия за сессию (оценка на основе общей практики e-commerce).
- **Добавления товаров в корзину:** Количество добавлений в корзину примерно в 3 раза превышает число заказов. Это порядка 25–30 млн добавлений в корзину в сутки, или ~1,3 события «Add to cart» на одного пользователя (расчёт: 8,8 млн * 3 / 20 млн ≈ 1,3)
- **Оформление заказа**: по данным [\[7\]](https://mertech.ru/blog/marketpleisy/kak-otkryt-punkt-vydachi-zakazov-wildberries-v-2024/#:~:text=Wildberries%20%E2%80%94%20%D1%81%D0%B0%D0%BC%D1%8B%D0%B9%20%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9), обрабатывается 8,8 млн заказов в сутки. Делим на 14 млн DAU — получается ~0,63 заказа на пользователя в день.
- **Прочие действия**: добавление товаров в избранное, написание отзывов, смена настроек, переход в личный кабинет и т.д.

В сумме выходит **~15–20 действий** на одного пользователя в день.

---

### 2. Средний размер хранилища на одного пользователя

Данные, связанные с одним пользователем (история заказов, содержимое текущей корзины, отзывы, сохраненные товары и пр.) занимают относительно небольшой объём.

| **Тип**                                   | **Примерный объём** |
|-------------------------------------------|---------------------|
| Профиль (учётная запись, настройки)       | ~2–5 КБ             |
| История заказов                           | ~20 КБ              |
| Корзина и избранное                       | <1 КБ (динамически) |
| Отзывы                                    | 0–1 КБ              |

1. **Профиль**: ФИО, телефон, email, адрес(а) доставки, минимальные настройки. Оценочно 2–5 КБ текстовых данных.
2. **История заказов**:
Объём хранения истории заказов = Количество заказов пользователя в год × Средний размер записи о заказе.
   Если 1 заказ/месяц, то за год 12 заказов. При ~1 КБ метаданных на заказ получаем ~12 КБ/год. В среднем ~несколько десятков КБ на «тяжёлого» покупателя.
3. **Корзина и избранное**: хранятся идентификаторы товаров, их количество (обычно несколько товаров, <1 KB).
4. **Отзывы**: в среднем 1 отзыв на 15 заказов​ [8] , каждый отзыв – текст ~0,2–0,5 KB). В сумме получается порядка килобайта на пользователя.

Таким образом, **~50–100 КБ** достаточно для описания одного активного пользователя (вместе со всей историей). При 76,7 млн MAU [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf) общий объём может достигать нескольких терабайт.

---

### 3. Технические метрики

| **Тип данных**                      | **Расчёт объёма данных**                                     | **Объём хранения (TB)** |
|------------------------------------|--------------------------------------------------------------|-------------------------|
| **Каталог товаров (SKU)**          | 40 млн × 2 KB = 80 млн KB                                    | ≈ 0,08 TB              |
| **Изображения товаров**            | 40 млн × 5 изображений × 0,2 MB = 40 млн MB                  | ≈ 38 TB                |
| **История заказов (5 лет)**        | ~16 млрд × 1 KB = 16 млрд KB                                 | ≈ 16 TB                |
| **Отзывы пользователей**           | ~1 млрд × 0,5 KB = 0,5 млрд KB                               | ≈ 0,5 TB               |
| **Прочие данные (профили, справочники и др.)** | 76,7 млн × 1 KB = 76,7 млн KB                                | ≈ 0,07 TB              |

- **Каталог товаров (SKU):** При 40 млн товарных позиций со средним размером записи 2 KB общий объем данных составляет 40 000 000 × 2 KB ≈ 80 000 000 KB, что эквивалентно примерно 0,08 TB хранения.
- **Изображения товаров:** Для ~40 млн товаров, у каждого в среднем по 5 изображений размером ~0,2 MB, суммарный объем изображений оценивается как 40 000 000 × 5 × 0,2 MB ≈ 40 000 000 MB. Это соответствует приблизительно 38 TB (так как 1 TB ≈ 1 048 576 MB в двоичной системе).
- **История заказов:** Поступление ~8,8 млн заказов в день приводит к ~16 млрд записей за 5 лет. При среднем размере 1 KB на запись общая история заказов займет около 16 000 000 000 × 1 KB = 16 000 000 000 KB, что примерно равно 16 TB.
- **Отзывы пользователей:** Поскольку в среднем приходится 1 отзыв на 15 заказов, за 5 лет набирается порядка 1 млрд отзывов. При среднем размере отзыва ~0,5 KB суммарный объем данных отзывов будет ≈ 1 000 000 000 × 0,5 KB = 500 000 000 KB, то есть около 0,5 TB (примерно полтерабайта).
- **Прочие данные:** В эту категорию входят профили ~76,7 млн пользователей, справочники и др. При среднем размере записи ~1 KB общий объем составляет 76 700 000 × 1 KB = 76 700 000 KB, что порядка 0,07 TB хранения, данные профиля ~1 KB => ~0,07 TB; данные о продавцах (~1 млн продавцов) и категории – еще несколько GB. В сумме незначительно относительно прочего. 
---

### 4. Сетевой трафик

| **Действие**                                     | **Трафик на действие** | **Среднее потребление (Гбит/с)** | **Пиковое потребление (Гбит/с)** | **Суммарный суточный трафик (ГБ/сутки)**                                                                                                                                     |
|--------------------------------------------------|------------------------|----------------------------------|----------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Просмотр каталога / карточки товара**          | ~2 МБ                 | ~25–30                           | ~60–70                           | **344 000**<br/>Расчёт: 168 млн просмотров в сутки × 2 МБ = 336 000 000 МБ = 336 000 МБ ~ 336 ТБ → в ГБ: 336 000 × 1024 ≈ 344 064 ГБ                                                                                    |
| **Поиск / фильтрация**                           | ~50–100 КБ            | ~2–3                             | ~5–6                              | **350–700**<br/>Зависит от количества запросов: при 5–10 млн запросов в сутки и среднем 75 КБ на ответ, получается ~0,35–0,7 ТБ (350–700 ГБ)                                                                          |
| **Оформление заказа**                            | ~100–200 КБ           | ~1–2                             | ~3–4                              | **800–1 600**<br/>8,8 млн заказов в сутки, в среднем 150 КБ на заказ: 8,8 млн × 150 КБ ≈ 1,3×10^9 КБ ~ 1,2–1,6 ТБ (800–1 600 ГБ)                                                                                       |
| **Добавление в корзину / избранное (AJAX)**      | ~10–50 КБ             | <1                                | ~1–2                              | **200–400**<br/>Приблизительно 0,5–1 операции на пользователя (14 млн DAU). Например, 7–14 млн добавлений × 30 КБ = 210–420 млн КБ ~ 200–400 ГБ в сутки                                                                |
---

Пояснения к расчётам:

1. **Просмотр каталога/карточки**  
   - *168 млн просмотров/день* (12 страниц × 14 млн DAU).  
   - *Средний вес страницы ~2 МБ* (HTML + JS/CSS + изображения).  
   - Итого: 168 000 000 × 2 МБ = 336 000 000 МБ = 336 000 МБ = 336 000 ТБ/1024 ≈ 344 064 ГБ.  
   - В таблице округлено до 344 000 ГБ.

2. **Поиск / фильтрация**  
   - Средний ответ: 50–100 КБ (список товаров, краткая информация).  
   - Количество поисковых запросов сильно варьируется; при 5–10 млн запросов/сутки получается ориентировочно 350–700 ГБ.

3. **Оформление заказа**  
   - ~8,8 млн заказов/день × 100–200 КБ на процесс (данные о товаре, подтверждение, оплата) = ~0,8–1,6 ТБ в сутки (800–1600 ГБ).  

4. **Добавление в корзину / избранное**  
   - ~10–50 КБ на одно добавление (AJAX-запрос). При ~7–14 млн таких операций в сутки общий трафик 200–400 ГБ.

### 5. RPS (Requests per Second)

| **Тип запроса**                     | **Средний RPS** | **Пиковый RPS** |
|-------------------------------------|-----------------|-----------------|
| Просмотр каталога / карточек товара | ~1 900–2 000    | ~4 000–6 000    |
| Поиск / фильтрация                  | ~500–1 000      | ~2 000–3 000    |
| Оформление заказа                   | ~100            | ~300            |
| Добавление в корзину / избранное    | ~300–500        | ~1 000          |
| **Итого (примерно)**                | ~2 800–3 600    | ~7 000–10 000   |


1. **Просмотр каталога / карточек товара**  
   - В среднем 14 млн DAU (активных пользователей в день). Каждый просматривает ~12 страниц.  
   - Итого в сутки: 14 млн × 12 = 168 млн просмотров.  
   - Делим на количество секунд в сутках (86 400):  
     ```
     168 000 000 / 86 400 ≈ 1 945 RPS
     ```
   - Для удобства округляем до 1 900–2 000 в таблице. Пиковое значение обычно в 2–3 раза выше.

2. **Поиск / фильтрация**  
   - Допустим, 30–60% пользователей делают несколько поисковых запросов. Например, если взять 5 млн – 10 млн поисковых действий за сутки.  
   - 5 000 000 / 86 400 ≈ 58 RPS, 10 000 000 / 86 400 ≈ 116 RPS. Но при учёте, что часть пользователей может делать 2–3 поисковых запроса, итоговая нагрузка может вырасти до ~500 RPS.  
   - Также бывают всплески в часы пик или распродажи, когда поисковая активность кратно увеличивается. Поэтому берём диапазон 500–1 000 RPS. Пиковое 2 000–3 000.

3. **Оформление заказа**  
   - В сутки: 8,8 млн заказов (по данным маркетплейса).  
   - Делим: 8 800 000 / 86 400 ≈ 102 RPS.  
   - С учётом округлений и неравномерной активности в разное время суток указываем ~100 RPS в среднем, и 2–3 кратное увеличение в пике.

4. **Добавление в корзину / избранное**  
   - Предположим, в день ~70% DAU делает 1–2 добавления: это 14 млн × 0,7 × (в среднем ~1,5 добавления) = ~14,7 млн действий.  
   - 14 700 000 / 86 400 ≈ 170 RPS. Но может быть выше за счёт «серфинга» (многие добавляют несколько товаров).  
   - Усреднённо указываем 300–500. Пиковое в 2–3 раза больше.

5. **Итого (примерно)**  
   - Складываем разные типы операций: 1 900–2 000 (просмотры) + 500–1 000 (поиск) + 100 (заказы) + 300–500 (корзина) ≈ 2 800–3 600 RPS.  
   - В период распродаж суммарная пиковая нагрузка может дойти до 7 000–10 000 RPS. В отдельных сервисах (например, поиск) бывают кратковременные всплески до сотен тысяч RPS, когда начинается массовый заход пользователей.


**Среднее количество запросов в секунду (RPS) рассчитывается по формуле:**  
> _RPS (Requests Per Second) = Общее количество операций в сутки / Количество секунд в сутках (86 400)._  


## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам

- wildberries.ru — API-сервисы для мобильных приложений и веб-версии.
- cdn.wildberries.ru — доставка медиа-контента (фото товаров, видео, баннеры).
- wbxoofex.wildberries.ru — сервис оформления заказов и управления корзиной.
- search.wb.ru — отдельный домен для поиска товаров.
- seller.wildberries.ru — платформа для продавцов.

### Расположение ДЦ

Wildberries ориентирован на российский рынок и страны СНГ. Компания использует распределенную логистическую сеть, включая склады и пункты выдачи. Логично предположить, что дата-центры размещены в регионах с высокой плотностью населения:

- Москва и Московская область (основной хаб бизнеса, высокая плотность населения).

- Санкт-Петербург (второй по величине рынок).

- Екатеринбург, Новосибирск (крупные логистические узлы для Урала и Сибири).

### Расчет распределения запросов 
Учитывая следующее:
1. **География пользователей**: Основная аудитория сосредоточена в европейской части России (Москва, Санкт-Петербург), Урале (Екатеринбург) и Сибири (Новосибирск). 
2. **Плотность населения и активность**: 
   - Москва и МО: ~45% трафика.
   - Санкт-Петербург: ~20%.
   - Екатеринбург: ~15%.
   - Новосибирск: ~10%.
   - Прочие регионы: ~10%.
3. **Типы запросов**:
   - **Просмотр каталога/карточек товара** (высокий трафик, низкая задержка).
   - **Поиск и фильтрация** (требует быстрого ответа).
   - **Добавление в корзину/избранное** (AJAX-запросы, низкий объем).
   - **Оформление заказа** (критично к надежности, но менее чувствительно к задержкам).

---

#### Таблица распределения RPS по дата-центрам
| Тип запроса                | Средний RPS (общий) | Москва (45%) | СПб (20%) | Екатеринбург (15%) | Новосибирск (10%) | Прочие (10%) |
|----------------------------|---------------------|--------------|-----------|---------------------|--------------------|--------------|
| **Просмотр каталога**       | 1,900–2,000         | 855–900      | 380–400   | 285–300             | 190–200            | 190–200      |
| **Поиск/фильтрация**        | 500–1,000           | 225–450      | 100–200   | 75–150              | 50–100             | 50–100       |
| **Оформление заказа**       | ~100                | 45           | 20        | 15                  | 10                 | 10           |
| **Добавление в корзину**    | 300–500             | 135–225      | 60–100    | 45–75               | 30–50              | 30–50        |
| **Итого RPS**               | **2,800–3,600**     | **1,260–1,620** | **560–720** | **420–540**         | **280–360**        | **280–360**  |

---

1. **Просмотр каталога и поиск**:
   - Распределяются пропорционально активности пользователей. Для снижения задержек статический контент (изображения, CSS/JS) кэшируется через CDN, размещенный во всех дата-центрах.

2. **Оформление заказов**:
   - Централизованы в Москве и СПб (65% нагрузки), так как эти узлы обеспечивают синхронизацию с основными логистическими хабами. Транзакции реплицируются в другие дата-центры для отказоустойчивости.

3. **Добавление в корзину**:
   - Запросы распределяются равномерно, но с приоритетом на крупные узлы (Москва, СПб) из-за высокой частоты действий.



### Схема балансировки 
Для Wildberries оптимальной схемой балансировки нагрузки является DNS-балансировка с географической привязкой (GeoDNS). Эта схема позволяет распределять трафик между дата-центрам в Москве, Санкт-Петербурге, Екатеринбурге и Новосибирске на основе геолокации пользователя.

1. Определение местоположения пользователя: DNS-сервер анализирует IP-адрес запроса и определяет регион пользователя (например, Москва, Урал, Сибирь).

2. Выбор ближайшего дата-центра: Пользователю возвращается IP-адрес ближайшего к нему дата-центра. 

3. TTL (Time to Live): Устанавливается низкое значение TTL (например, 60–300 секунд), чтобы быстро перенаправлять трафик при сбоях или изменениях нагрузки.

Обоснование:
1) Географическая оптимизация задержек: Для e-commerce (особенно при просмотре каталога и поиске) это критично: задержки >100 мс снижают конверсию на 1.11% [10]
2) Гибкость управления нагрузкой: Возможность ручного перенаправления трафика. Например, при перегрузке московского дата-центра часть запросов из Центральной России можно направить в СПб.
3) Локализация данных: Соответствие закону о локализации персональных данных (ФЗ-152). GeoDNS гарантирует, что данные пользователей из РФ обрабатываются в российских дата-центрах.
---
## 4. Локальная балансировка нагрузки 

После глобальной балансировки (GeoDNS), которая отправляет пользователя в ближайший или наименее загруженный дата-центр Wildberries (Москва, Санкт-Петербург, Екатеринбург, Новосибирск и т. д.), весь входящий трафик в рамках одного ДЦ проходит через **HTTP/HTTPS Reverse Proxy** (уровень L7).  

Для Wildberries — крупного маркетплейса с большим количеством отдельных микросервисов (каталог, поиск, корзина, оформление заказов, личные кабинеты и пр.) — такой подход обеспечивает:

1. **Маршрутизацию** по URI, заголовкам, cookies (например, `/search` → сервис поиска).
2. **SSL-терминацию** (разгрузка бэкенда от шифрования/дешифрования).
3. **Кэширование** (статика, часть динамических ответов) и компрессию (Gzip).
4. **Высокую пропускную способность** при относительно простом горизонтальном масштабировании.
5. **Отказоустойчивость** за счёт health-check.

### Основные возможности L7-балансировщика

- **SSL Termination**  
  Сокращает нагрузку на микросервисы: зашифрованное соединение заканчивается на прокси (Nginx/HAProxy), внутренняя передача может идти без шифрования или по отдельному TLS, в зависимости от политики безопасности.  

- **Гибкая маршрутизация**  
  Можно определить разные пулы серверов для поисковых запросов, оформления заказов, работы личного кабинета продавца и т. п.

- **Кэширование**  
  Хранение статического контента (CSS/JS/картинок) и части динамики (актуальные промо-баннеры, рекомендации), чтобы ускорять отдачу ответов и снижать нагрузку на бэкенды.

- **Переключение при сбое**  

## Применение в Wildberries

- **Просмотр каталога** (высокий трафик, до нескольких тысяч RPS).  
  Кэширование изображений и статики существенно разгружает backend и сокращает задержку ответа.
- **Поиск/фильтрация** (требуются быстрый отклик и часто обновляемые данные).  
  L7-прокси маршрутизирует запросы на отдельный поисковый сервис (или кластер Elasticsearch/Solr/и т. п.).
- **Корзина/избранное** (короткие AJAX-запросы).  
  Можно активировать sticky sessions, если нужно хранить локальное состояние.
- **Оформление заказа** (критичен к надёжности).  
  Balance Proxy проверяет доступность платежных и CRM-сервисов. При сбое автоматически переключается.
- **Личный кабинет (покупателя/продавца)**.  
  Индивидуальные данные пользователя (скрытая информация) обрабатываются за защищёнными endpoint’ами (HTTPS + авторизация).

## Расчёт нагрузки и требуемых ядер CPU

В пиковые периоды Wildberries может достигать общего RPS порядка **10 000** (суммарно по всем сервисам). Распределение по дата-центрам (упрощённо):

- **Москва**: ~45%  
- **Санкт-Петербург**: ~20%  
- **Екатеринбург**: ~15%  
- **Новосибирск**: ~10%  
- **Прочие**: ~10%

Допустим, средний оверхед обработки 1 HTTPS-запроса (TLS handshake + разбор HTTP-заголовков) ~**0,75 мс** CPU, а полезная нагрузка в среднем ~**1 КБ** на запрос.

Ниже сводная таблица для **пиковых** значений RPS:

| Датацентр          | RPS   | Объём данных (МБ/с)                   | CPU, мс/с (RPS × 0,75 мс) | Примерные ядра CPU* |
|--------------------|-------|---------------------------------------|---------------------------|----------------------|
| **Москва**         | 4 500 | 4 500 × 1 КБ ≈ **4,39 МБ/с**           | 4 500 × 0,75 мс = 3 375 мс/с | ~3,4                |
| **Санкт-Петербург**| 2 000 | 2 000 × 1 КБ ≈ **1,95 МБ/с**           | 2 000 × 0,75 мс = 1 500 мс/с | ~1,5                |
| **Екатеринбург**   | 1 500 | 1 500 × 1 КБ ≈ **1,46 МБ/с**           | 1 500 × 0,75 мс = 1 125 мс/с | ~1,1                |
| **Новосибирск**    | 1 000 | 1 000 × 1 КБ ≈ **0,98 МБ/с**           | 1 000 × 0,75 мс = 750 мс/с   | ~0,75               |
| **Прочие**         | 1 000 | 1 000 × 1 КБ ≈ **0,98 МБ/с**           | 1 000 × 0,75 мс = 750 мс/с   | ~0,75               |
| **Итого**          | 10 000| ≈ **9,76–10 МБ/с**                    | 7 500 мс/с                | ~7,5                |

> \* Предполагается, что **1 CPU ядро** способно обработать 1 000 мс CPU в секунду.  

Это ориентировочные цифры для пикового момента (новые HTTPS-сессии, без учёта session reuse). С caching, session tickets и прочими оптимизациями реальная нагрузка на CPU снижается.

- **L7-балансировка (HTTP Reverse Proxy)** — ключевой элемент обеспечения высокой доступности и производительности в Wildberries внутри каждого дата-центра.
- **Гибкая маршрутизация**, **кэширование** и **SSL-терминация** централизованы в одном слое (Nginx/HAProxy), упрощая масштабирование и администрирование.
- **Масштабирование** достигается путём увеличения числа Nginx-инстансов либо автоматической оркестрации (Kubernetes/Ingress-controller), что позволяет эффективно обрабатывать пиковые нагрузки в десятки тысяч RPS.

## 5. Логическая схема БД
https://dbdiagram.io/d/DB-67d834af75d75cc844632f37

---

### 1. Описанием таблиц и основных полей

| **Название таблицы**     | **Назначение**                                                                                                                                                | **Основные поля**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | **Связи**                                                                                                                                                           |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **users**                | Хранение информации о пользователях (как покупателях, так и продавцах, администраторах и т.д.).                                                              | - **id** (PK) – уникальный идентификатор<br>- **name** – имя пользователя<br>- **email** – адрес электронной почты<br>- **password** – пароль (хранить в виде хеша)<br>- **user_type** – тип пользователя (buyer, seller, admin)<br>- **region**, **geolocation** – локационные данные для персонализации и доставки<br>- **created_at**, **updated_at** – даты создания и обновления записи                                                                                | - Связь «1 ко многим» с таблицей **products** (seller_id → users.id)<br>- Связь «1 ко многим» с **carts** (user_id → users.id)<br>- Связь «1 ко многим» с **orders** (user_id → users.id)                   |
| **products**             | Каталог товаров, включая название, описание, цену, привязку к продавцу и т.д.                                                                                 | - **id** (PK) – уникальный идентификатор<br>- **seller_id** (FK на **users**.id) – продавец<br>- **name** – название<br>- **description** – описание<br>- **price** – цена<br>- **brand** – бренд (для фильтрации)<br>- **image_url** – ссылка на изображение (или несколько полей/таблиц для хранения мультимедиа)<br>- **created_at**, **updated_at** – даты создания и обновления                                                                                                      | - Связь «многие к одному» с **users** (seller_id)<br>- Связь «многие ко многим» с **categories** через **product_categories**<br>- Связь «1 ко многим» с **views** (product_id) |
| **categories**           | Справочник категорий товаров (дерево категорий или плоский список).                                                                                           | - **id** (PK) – уникальный идентификатор<br>- **name** – наименование категории<br>- **parent_id** (FK на **categories**.id) – для иерархической структуры категорий (при необходимости)                                                                                                                                                                                                                                                                                                      | - Связь «многие к одному» саму с собой (parent_id → categories.id)<br>- Через **product_categories** связывается с **products**                                                                           |
| **product_categories**   | Таблица-связка «многие ко многим» между товарами и категориями.                                                                                              | - **product_id** (FK на **products**.id)<br>- **category_id** (FK на **categories**.id)<br>- PK по паре (product_id, category_id)                                                                                                                                                                                                                                                                                                                                                              | - Связь «многие ко многим» между **products** и **categories**                                                                                                       |
| **favorites**            | Хранение «избранного» для каждого покупателя (список товаров, которые пользователь добавил в избранное).                                                     | - **user_id** (FK на **users**.id)<br>- **product_id** (FK на **products**.id)<br>- **created_at**<br>- PK по паре (user_id, product_id)                                                                                                                                                                                                                                                                                                                                                       | - Связь «многие ко многим» (через отдельную таблицу) между **users** и **products**, но в данном случае PK = (user_id, product_id)                                                                         |
| **views**                | Учет просмотренных товаров пользователем (для рекомендаций и аналитики).                                                                                     | - **id** (PK) – уникальный идентификатор<br>- **user_id** (FK на **users**.id)<br>- **product_id** (FK на **products**.id)<br>- **viewed_at** – дата/время просмотра                                                                                                                                                                                                                                                                                                                           | - Связь «многие ко многим» (фактически через дополнительную информацию) между **users** и **products**, но реализуется как «1 ко многим» для каждой из сторон         |
| **search_queries**       | Хранение истории поисковых запросов пользователей (для рекомендаций и анализа популярности товаров).                                                          | - **id** (PK) – уникальный идентификатор<br>- **user_id** (FK на **users**.id)<br>- **query** – текст поискового запроса<br>- **created_at** – дата/время запроса                                                                                                                                                                                                                                                                                                                             | - Связь «многие ко многим» (через дополнительную информацию) между **users** и поисковым контентом (сам запрос)                                                      |
| **carts**                | Корзина товаров для каждого пользователя (активная корзина до оформления заказа).                                                                             | - **id** (PK) – уникальный идентификатор<br>- **user_id** (FK на **users**.id)<br>- **created_at**, **updated_at**                                                                                                                                                                                                                                                                                                                                                                            | - Связь «1 ко многим» (user_id → users.id)<br>- Связь «1 ко многим» с **cart_items**                                                                                |
| **cart_items**           | Содержимое корзины (товары и их количество).                                                                                                                  | - **id** (PK) – уникальный идентификатор<br>- **cart_id** (FK на **carts**.id)<br>- **product_id** (FK на **products**.id)<br>- **quantity**<br>- **created_at**, **updated_at**                                                                                                                                                                                                                                                                                                             | - Связь «многие к одному» с **carts** и **products**                                                                                                                |
| **orders**               | Оформленные заказы пользователей.                                                                                                                             | - **id** (PK) – уникальный идентификатор<br>- **user_id** (FK на **users**.id)<br>- **order_date**<br>- **status** – статус заказа (напр. «Новый», «Оплачен», «Доставляется», «Завершен», «Отменен») <br>- **payment_method**<br>- **shipping_method**<br>- **shipping_address**, **shipping_city**, **shipping_region**, **shipping_postal_code**<br>- **total_amount**<br>- **created_at**, **updated_at**                                                                                                           | - Связь «1 ко многим» (user_id → users.id)<br>- Связь «1 ко многим» с **order_items** (order_id → orders.id)<br>- Связь «1 к 1» или «1 ко многим» с **payments** и **shipment_tracking**                    |
| **order_items**          | Перечень товаров в заказе (в т.ч. количество и цена на момент оформления).                                                                                   | - **id** (PK) – уникальный идентификатор<br>- **order_id** (FK на **orders**.id)<br>- **product_id** (FK на **products**.id)<br>- **quantity**<br>- **unit_price**, **total_price**<br>- **created_at**, **updated_at**                                                                                                                                                                                                                                                                       | - Связь «многие к одному» (order_id → orders.id), (product_id → products.id)                                                                                        |
| **payments**             | Информация об оплатах (для одного заказа может быть несколько платежей или один платеж).                                                                     | - **id** (PK) – уникальный идентификатор<br>- **order_id** (FK на **orders**.id)<br>- **amount**<br>- **payment_date**<br>- **status** (напр. «Проведён», «Отклонён», «В обработке»)<br>- **payment_method** – какой сервис/метод оплаты<br>- **transaction_id**<br>- **created_at**, **updated_at**                                                                                                                                                                                        | - Связь «многие к одному» (order_id → orders.id)                                                                                                                    |
| **shipment_tracking**    | Данные для отслеживания доставки (трек-номер и статус посылки).                                                                                              | - **id** (PK) – уникальный идентификатор<br>- **order_id** (FK на **orders**.id)<br>- **tracking_number**<br>- **status**<br>- **updated_at**                                                                                                                                                                                                                                                                                                                                                 | - Связь «1 ко многим» (order_id → orders.id)                                                                                                                       |


### Размеры данных и нагрузки на чтение/запись

Ниже приведена **сводная таблица** по нагрузке на чтение и запись (RPS — запросы в секунду) для каждой ключевой таблицы, исходя из общего распределения действий пользователей (просмотры, поиск, оформление заказов, добавление в корзину и т.д.). 


---

## Таблица чтения/записи по RPS

| **Таблица**           | **Типовые операции**                                                           | **Чтение (RPS)**                         | **Запись (RPS)**                          | **Комментарий**                                                                                              |
|-----------------------|-------------------------------------------------------------------------------|------------------------------------------|-------------------------------------------|----------------------------------------------------------------------------------------------------------------|
| **users**             | - Получение профиля<br>- Регистрация/обновление данных                        | ~50–100                                   | ~2–5                                      | Чтение: при входе в «Личный кабинет», авторизации, проверке статуса<br>Запись: реже — регистрация, смена email и т.п.                                |
| **products**          | - Просмотр карточки товара<br>- Список товаров в каталоге<br>- Обновление цены | ~1 500–2 000                              | ~50–80                                    | Одна из самых часто читаемых таблиц (просмотры каталога).<br>Запись в основном от продавцов/админов при изменении товара.                            |
| **categories**        | - Загрузка списка категорий<br>- Отображение структуры каталога                | ~300–500                                  | ~1–2                                      | Нагрузка в основном на чтение. Данные категории меняются редко (добавление/редактирование администратором).                                        |
| **product_categories**| - Определение категорий для товара (фильтры, поиск)                            | ~300–500                                  | ~10–20                                    | Большинство операций — чтение при фильтрации/поиске, редкие массовые обновления (прикрепление товара к категории).                                   |
| **favorites**         | - Проверка, есть ли товар в избранном<br>- Добавление/удаление из избранного   | ~100–200                                  | ~50–100                                   | Довольно часто пользователи смотрят, добавлен ли товар в избранное. Запись — при нажатии «Добавить/Удалить из избранного».                          |
| **views**             | - Аналитика просмотров (запись факта просмотра)                                | ~10–50                                    | ~400–600                                  | Большой объём записей (каждый просмотр фиксируется). В реальном проекте часто складывают в отдельный сервис/лог.                                     |
| **search_queries**    | - Аналитика поисковых запросов (запись)                                        | ~5–10                                     | ~100–200                                  | Основная нагрузка — именно запись (лог каждого запроса). Чтение — эпизодическое (аналитика, рекомендательная система).                               |
| **carts**             | - Проверка содержимого корзины<br>- Создание новой корзины                     | ~200–300                                  | ~150–200                                  | Почти равномерное чтение/запись: чтение при открытии страницы корзины, запись при добавлении/удалении товаров.                                       |
| **cart_items**        | - Данные о конкретных товарах в корзине                                        | ~200–300                                  | ~150–200                                  | Аналогично «carts». Обычно изменения идут пакетами (добавить товар → обновить `cart_items`).                                                         |
| **orders**            | - Просмотр истории заказов<br>- Создание нового заказа                         | ~50–100                                   | ~100                                      | Запись в момент оформления заказа; чтение при просмотре истории, проверке статуса и т.д.                                                            |
| **order_items**       | - Детализация позиций заказа                                                   | ~50–100                                   | ~100                                      | Похожие цифры, так как создаётся несколько позиций (sku) на один заказ.                                                                              |
| **payments**          | - Проверка статуса платежа<br>- Запись факта платежа                           | ~20–30                                    | ~50–80                                    | Относительно невысокая нагрузка по сравнению с просмотрами товаров.                                                                                  |
| **shipment_tracking** | - Отслеживание доставки                                                        | ~20–30                                    | ~10–20                                    | Большинство обращений на чтение (статус посылки). Записи происходят, когда меняется статус трекинга.                                                 |

---

- При **суммарном RPS** (просмотры, корзина, поиск, оформление и т.д.) ~2 800–3 600 в среднем (и до 7 000–10 000 в пике) **далеко не все** запросы доходят до каждой таблицы.  
- Часть запросов — кэшированные данные (CDN статика, redis-cache и т.д.), часть — вообще не идут в SQL-базу.
- Поэтому реальные RPS на каждую таблицу оказываются ниже, чем суммарный RPS на уровень веб-сервиса.


### Требования к консистентности

1. **ACID-транзакции**  
   - Для оформления заказов, списания платежей и т.д. необходима полная гарантия целостности (Atomicity, Consistency, Isolation, Durability).  
   - Используйте транзакции в СУБД (например, PostgreSQL / MySQL / MS SQL) при создании заказа, записи в `orders`, `order_items`, `payments`.  

2. **Eventual consistency** (поздняя согласованность) может использоваться в отдельных случаях:  
   - Записи в таблицы логов (`views`, `search_queries`) или обновление кэшей могут обрабатываться асинхронно.  
   - Рекомендательные сервисы могут работать на данных, которые обновляются не в реальном времени, а с задержкой.  

3. **Уровень изоляции**  
   - Для операций с корзиной можно ограничиться `READ COMMITTED` или более низким уровнем, если бизнес-логика допускает небольшую возможность конфликта и повторных проверок.  
   - Для операций с оплатой и заказом (финансовые транзакции) рекомендуется более высокий уровень изоляции (например, `SERIALIZABLE` или как минимум `REPEATABLE READ`, если движок СУБД это поддерживает без существенной потери производительности).

---

### 5. Особенности распределения нагрузки по ключам

При масштабировании и большом объёме данных возникают вопросы **шардирования** и **репликации**:

- **Горизонтальное шардирование по пользователям (user_id)**  
  - Таблицы, сильно зависящие от пользователя: `carts`, `views`, `search_queries`, `favorites` и др., можно партиционировать или шардировать по `user_id`.  
  - Это распределяет нагрузку на чтение/запись по нескольким узлам, так как запросы, связанные с одним пользователем, будут попадать на конкретный шард.

- **Партиционирование по дате**  
  - Для «логов» (например, `views`, `search_queries`) часто используют **партиционирование по времени** (партиции по месяцам/неделям). Устаревшие данные можно либо архивировать, либо хранить в менее дорогом хранилище.  

- **Репликация**  
  - Для повышения отказоустойчивости и скорости чтения (особенно запросов, связанных с просмотром каталога, поиском товаров и т.п.) используют реплики. Основной узел (Primary) отвечает за запись, а чтение масштабируется за счёт Replica-нод.




## Список источников

1. [Wildberries — ruwiki](https://ru.ruwiki.ru/wiki/Wildberries)  
2. [SimilarWeb: Wildberries (overview)](https://www.similarweb.com/ru/website/wildberries.ru/#overview)  
3. [CMP Wildberries (Special project kit) — аудитория, статистика](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)  
4. [Retail.ru: Оборот Wildberries, 14 млн посетителей в день](https://www.retail.ru/news/oborot-wildberries-vyros-na-101-v-iii-kvartale-15-oktyabrya-2021-210183/)  
5. [Data Insight — Sellers Monitoring 2024 (40 млн SKU)](https://datainsight.ru/sites/default/files/DI_Sellers_monitoring_2024_1_0.pdf?ysclid=m7px4bgk8r609130117)  
6. [Plusworld: Средняя цена и средний чек на маркетплейсах](https://plusworld.ru/articles/62655/#:~:text=%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D1%8F%D1%8F%20%D1%86%D0%B5%D0%BD%D0%B0%20%D0%BD%D0%B0%20%D0%BC%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%D0%B5)  
7. [Mertech.ru: 8,8 млн заказов Wildberries в сутки](https://mertech.ru/blog/marketpleisy/kak-otkryt-punkt-vydachi-zakazov-wildberries-v-2024/#:~:text=Wildberries%20%E2%80%94%20%D1%81%D0%B0%D0%BC%D1%8B%D0%B9%20%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9)  
8. [HTTP Archive: Статистика «веса» страницы](https://httparchive.org/reports/page-weight)  
9. [Workspace.ru](https://workspace.ru/blog/algoritmy-ranzhirovaniya-na-wildberries-kak-oni-rabotayut-i-kak-uluchshit-vidimost-svoih-tovarov/)
10. https://www.cloudflare.com/learning/performance/why-site-speed-matters/
