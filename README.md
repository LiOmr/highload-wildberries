## Wildberries: Описание проекта

## 1. Тема и целевая аудитория

Wildberries (также «Ва́йлдберриз») — крупнейший маркетплейс в России, специализирующийся на продаже товаров различных категорий, включая одежду, обувь, бытовую технику и электронику, товары для дома, косметику и многое другое [\[1\]](https://ru.ruwiki.ru/wiki/Wildberries). 

### Продуктовые метрики
- 76,7 млн уникальных посетителей в месяц [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- 14 млн уникальных посетителей в день [\[4\]](https://www.retail.ru/news/oborot-wildberries-vyros-na-101-v-iii-kvartale-15-oktyabrya-2021-210183/)
- 41,3 млн активных покупателей в месяц [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- Количество активных* селлеров: 293 700 [\[5\]](https://datainsight.ru/sites/default/files/DI_Sellers_monitoring_2024_1_0.pdf?ysclid=m7px4bgk8r609130117)

- Число ежедневных заказов: 8,8 млн [\[7\]](https://mertech.ru/blog/marketpleisy/kak-otkryt-punkt-vydachi-zakazov-wildberries-v-2024/#:~:text=Wildberries%20%E2%80%94%20%D1%81%D0%B0%D0%BC%D1%8B%D0%B9%20%D0%BF%D0%BE%D0%BF%D1%83%D0%BB%D1%8F%D1%80%D0%BD%D1%8B%D0%B9%20%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9,%D0%BA%D0%BE%D1%82%D0%BE%D1%80%D0%B0%D1%8F%20%D0%BE%D1%82%D0%B2%D0%B5%D1%87%D0%B0%D0%B5%D1%82%20%D0%BD%D0%B0%20%D1%87%D0%B0%D1%81%D1%82%D1%8B%D0%B5%20%D0%B2%D0%BE%D0%BF%D1%80%D0%BE%D1%81%D1%8B)

- Среднее число страниц за один визит: 12 [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- Среднее время одного визита: 10 мин [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- Мобильные устройства: 86% [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)
- Десктоп: 14% [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

- Среднее число товаров в заказе покупателя: сумма среднего чека / средняя цена одного товара = 1 594 [\[6\]](https://plusworld.ru/articles/62655/#:~:text=%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D0%B8%D0%B9%20%D1%87%D0%B5%D0%BA%20%D0%BD%D0%B0%20%D0%BC%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%D0%B0%D1%85%20%D0%B2%D1%8B%D1%80%D0%BE%D1%81,%D0%BE%D0%BD%20%D1%81%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D0%B8%D0%BB%20793%20%D1%80%D1%83%D0%B1%D0%BB%D1%8F) / 750 = 2,1
- Среднее число товаров на одного селлера: общее количество товарных единиц на Wildberries (SKU) / число активных селлеров = 40 млн [\[9\]](https://workspace.ru/blog/algoritmy-ranzhirovaniya-na-wildberries-kak-oni-rabotayut-i-kak-uluchshit-vidimost-svoih-tovarov/) / 293 700 [\[5\]](https://datainsight.ru/sites/default/files/DI_Sellers_monitoring_2024_1_0.pdf?ysclid=m7px4bgk8r609130117) = 136,2

> *Активные селлеры – селлеры, у которых на момент сбора данных был хотя бы один товар в продаже на маркетплейсе

### Целевая аудитория

**1. Распределение по возрасту** [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

| Возраст     | Доля  |
|-------------|-------|
| < 18 лет    | 1%    |
| 18–25 лет   | 14%   |
| 26–35 лет   | 35%   |
| 36–45 лет   | 34%   |
| 46–60 лет   | 14%   |
| 60+ лет     | 2%    |

**2. Распределение по полу** [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

| Пол       | Доля  |
|-----------|-------|
| Женщины   | 66%   |
| Мужчины   | 34%   |

**3. Распределение по уровню дохода** [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)

| Уровень дохода | Доля  |
|----------------|-------|
| Низкий         | 6%    |
| Средний        | 57%   |
| Средний+       | 35%   |
| Высокий        | 2%    |

### Веб-трафик по странам
![image](https://github.com/user-attachments/assets/e15d7d94-e3af-48be-a5a7-2f702621858b) [\[2\]](https://www.similarweb.com/ru/website/wildberries.ru/#overview)

---

### Функционал MVP
**Ключевой функционал** - просмотр ленты товаров

1. Регистрация и авторизация пользователей.  
2. Каталог товаров (возможность добавления и управления товарами – название, описание, цена, фотографии).  
3. Поиск и фильтрация (фильтрация по цене, брендам и другим параметрам).  
4. Корзина и оформление заказа с выбором способа доставки и оплаты.  
5. Онлайн-оплата (минимум один способ онлайн-оплаты, безопасная передача платежных данных).  
6. Доставка (указание адреса доставки/пункта самовывоза, отслеживание статуса заказа).  
7. Личный кабинет покупателя.  
8. Индивидуальные рекомендации товаров на основе:
   - товаров, добавленных в избранное
   - просмотренных пользователем товаров
   - оформленных покупок
   - поисковых запросов
   - региона и геолокации пользователя  
9. Личный кабинет продавца.

---

## 2. Расчет нагрузки

| Характеристика | Значение |
|---------------|----------|
| MAU           | 76,7M    |
| DAU           | 14M      |

---

### 1. Среднее количество действий пользователя в день

| **Действие пользователя**                       | **Количество в день** |
|-------------------------------------------------|-----------------------|
| Просмотр страниц (каталог, карточка товара)     | ~12–13                |
| Поисковые запросы / фильтрация                  | ~2–3                  |
| Добавление в корзину / избранное                | ~1-1,3                |
| Оформление заказа                               | ~0,6                  |
| Прочие действия (личный кабинет, отзывы и т.п.) | 1–2                   |


- **Среднее число просмотренных страниц:** порядка 12 просмотренных товаров в день на одного активного пользователя,[3] Из которых значительная часть – это страницы товаров.
- **Поисковые запросы**: большинство пользователей совершает по 2–3 поисковых/фильтрационных действия за сессию (оценка на основе общей практики e-commerce).
- **Добавления товаров в корзину:** Количество добавлений в корзину примерно в 3 раза превышает число заказов. Это порядка 25–30 млн добавлений в корзину в сутки, или ~1,3 события «Add to cart» на одного пользователя (расчёт: 8,8 млн * 3 / 20 млн ≈ 1,3)
- **Оформление заказа**: по данным [\[7\]](https://mertech.ru/blog/marketpleisy/kak-otkryt-punkt-vydachi-zakazov-wildberries-v-2024/#:~:text=Wildberries%20%E2%80%94%20%D1%81%D0%B0%D0%BC%D1%8B%D0%B9%20%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9), обрабатывается 8,8 млн заказов в сутки. Делим на 14 млн DAU — получается ~0,63 заказа на пользователя в день.
- **Прочие действия**: добавление товаров в избранное, написание отзывов, смена настроек, переход в личный кабинет и т.д.

В сумме выходит **~15–20 действий** на одного пользователя в день.

---

### 2. Средний размер хранилища на одного пользователя

Данные, связанные с одним пользователем (история заказов, содержимое текущей корзины, отзывы, сохраненные товары и пр.) занимают относительно небольшой объём.

| **Тип**                                   | **Примерный объём** |
|-------------------------------------------|---------------------|
| Профиль (учётная запись, настройки)       | ~2–5 КБ             |
| История заказов                           | ~20 КБ              |
| Корзина и избранное                       | <1 КБ (динамически) |
| Отзывы                                    | 0–1 КБ              |

1. **Профиль**: ФИО, телефон, email, адрес(а) доставки, минимальные настройки. Оценочно 2–5 КБ текстовых данных.
2. **История заказов**:
Объём хранения истории заказов = Количество заказов пользователя в год × Средний размер записи о заказе.
   Если 1 заказ/месяц, то за год 12 заказов. При ~1 КБ метаданных на заказ получаем ~12 КБ/год. В среднем ~несколько десятков КБ на «тяжёлого» покупателя.
3. **Корзина и избранное**: хранятся идентификаторы товаров, их количество (обычно несколько товаров, <1 KB).
4. **Отзывы**: в среднем 1 отзыв на 15 заказов​ [8] , каждый отзыв – текст ~0,2–0,5 KB). В сумме получается порядка килобайта на пользователя.

Таким образом, **~50–100 КБ** достаточно для описания одного активного пользователя (вместе со всей историей). При 76,7 млн MAU [\[3\]](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf) общий объём может достигать нескольких терабайт.

---

### 3. Технические метрики

| **Тип данных**                      | **Расчёт объёма данных**                                     | **Объём хранения (TB)** |
|------------------------------------|--------------------------------------------------------------|-------------------------|
| **Каталог товаров (SKU)**          | 40 млн × 2 KB = 80 млн KB                                    | ≈ 0,08 TB              |
| **Изображения товаров**            | 40 млн × 5 изображений × 0,2 MB = 40 млн MB                  | ≈ 38 TB                |
| **История заказов (5 лет)**        | ~16 млрд × 1 KB = 16 млрд KB                                 | ≈ 16 TB                |
| **Отзывы пользователей**           | ~1 млрд × 0,5 KB = 0,5 млрд KB                               | ≈ 0,5 TB               |
| **Прочие данные (профили, справочники и др.)** | 76,7 млн × 1 KB = 76,7 млн KB                                | ≈ 0,07 TB              |

- **Каталог товаров (SKU):** При 40 млн товарных позиций со средним размером записи 2 KB общий объем данных составляет 40 000 000 × 2 KB ≈ 80 000 000 KB, что эквивалентно примерно 0,08 TB хранения.
- **Изображения товаров:** Для ~40 млн товаров, у каждого в среднем по 5 изображений размером ~0,2 MB, суммарный объем изображений оценивается как 40 000 000 × 5 × 0,2 MB ≈ 40 000 000 MB. Это соответствует приблизительно 38 TB (так как 1 TB ≈ 1 048 576 MB в двоичной системе).
- **История заказов:** Поступление ~8,8 млн заказов в день приводит к ~16 млрд записей за 5 лет. При среднем размере 1 KB на запись общая история заказов займет около 16 000 000 000 × 1 KB = 16 000 000 000 KB, что примерно равно 16 TB.
- **Отзывы пользователей:** Поскольку в среднем приходится 1 отзыв на 15 заказов, за 5 лет набирается порядка 1 млрд отзывов. При среднем размере отзыва ~0,5 KB суммарный объем данных отзывов будет ≈ 1 000 000 000 × 0,5 KB = 500 000 000 KB, то есть около 0,5 TB (примерно полтерабайта).
- **Прочие данные:** В эту категорию входят профили ~76,7 млн пользователей, справочники и др. При среднем размере записи ~1 KB общий объем составляет 76 700 000 × 1 KB = 76 700 000 KB, что порядка 0,07 TB хранения, данные профиля ~1 KB => ~0,07 TB; данные о продавцах (~1 млн продавцов) и категории – еще несколько GB. В сумме незначительно относительно прочего. 
---

### 4. Сетевой трафик

| **Действие**                                     | **Трафик на действие** | **Среднее потребление (Гбит/с)** | **Пиковое потребление (Гбит/с)** | **Суммарный суточный трафик (ГБ/сутки)**                                                                                                                                     |
|--------------------------------------------------|------------------------|----------------------------------|----------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **Просмотр каталога / карточки товара**          | ~2 МБ                 | ~25–30                           | ~60–70                           | **344 000**<br/>Расчёт: 168 млн просмотров в сутки × 2 МБ = 336 000 000 МБ = 336 000 МБ ~ 336 ТБ → в ГБ: 336 000 × 1024 ≈ 344 064 ГБ                                                                                    |
| **Поиск / фильтрация**                           | ~50–100 КБ            | ~2–3                             | ~5–6                              | **350–700**<br/>Зависит от количества запросов: при 5–10 млн запросов в сутки и среднем 75 КБ на ответ, получается ~0,35–0,7 ТБ (350–700 ГБ)                                                                          |
| **Оформление заказа**                            | ~100–200 КБ           | ~1–2                             | ~3–4                              | **800–1 600**<br/>8,8 млн заказов в сутки, в среднем 150 КБ на заказ: 8,8 млн × 150 КБ ≈ 1,3×10^9 КБ ~ 1,2–1,6 ТБ (800–1 600 ГБ)                                                                                       |
| **Добавление в корзину / избранное (AJAX)**      | ~10–50 КБ             | <1                                | ~1–2                              | **200–400**<br/>Приблизительно 0,5–1 операции на пользователя (14 млн DAU). Например, 7–14 млн добавлений × 30 КБ = 210–420 млн КБ ~ 200–400 ГБ в сутки                                                                |
---

Пояснения к расчётам:

1. **Просмотр каталога/карточки**  
   - *168 млн просмотров/день* (12 страниц × 14 млн DAU).  
   - *Средний вес страницы ~2 МБ* (HTML + JS/CSS + изображения).  
   - Итого: 168 000 000 × 2 МБ = 336 000 000 МБ = 336 000 МБ = 336 000 ТБ/1024 ≈ 344 064 ГБ.  
   - В таблице округлено до 344 000 ГБ.

2. **Поиск / фильтрация**  
   - Средний ответ: 50–100 КБ (список товаров, краткая информация).  
   - Количество поисковых запросов сильно варьируется; при 5–10 млн запросов/сутки получается ориентировочно 350–700 ГБ.

3. **Оформление заказа**  
   - ~8,8 млн заказов/день × 100–200 КБ на процесс (данные о товаре, подтверждение, оплата) = ~0,8–1,6 ТБ в сутки (800–1600 ГБ).  

4. **Добавление в корзину / избранное**  
   - ~10–50 КБ на одно добавление (AJAX-запрос). При ~7–14 млн таких операций в сутки общий трафик 200–400 ГБ.

### 5. RPS (Requests per Second)

| **Тип запроса**                     | **Средний RPS** | **Пиковый RPS** |
|-------------------------------------|-----------------|-----------------|
| Просмотр каталога / карточек товара | ~1 900–2 000    | ~4 000–6 000    |
| Поиск / фильтрация                  | ~500–1 000      | ~2 000–3 000    |
| Оформление заказа                   | ~100            | ~300            |
| Добавление в корзину / избранное    | ~300–500        | ~1 000          |
| **Итого (примерно)**                | ~2 800–3 600    | ~7 000–10 000   |


1. **Просмотр каталога / карточек товара**  
   - В среднем 14 млн DAU (активных пользователей в день). Каждый просматривает ~12 страниц.  
   - Итого в сутки: 14 млн × 12 = 168 млн просмотров.  
   - Делим на количество секунд в сутках (86 400):  
     ```
     168 000 000 / 86 400 ≈ 1 945 RPS
     ```
   - Для удобства округляем до 1 900–2 000 в таблице. Пиковое значение обычно в 2–3 раза выше.

2. **Поиск / фильтрация**  
   - Допустим, 30–60% пользователей делают несколько поисковых запросов. Например, если взять 5 млн – 10 млн поисковых действий за сутки.  
   - 5 000 000 / 86 400 ≈ 58 RPS, 10 000 000 / 86 400 ≈ 116 RPS. Но при учёте, что часть пользователей может делать 2–3 поисковых запроса, итоговая нагрузка может вырасти до ~500 RPS.  
   - Также бывают всплески в часы пик или распродажи, когда поисковая активность кратно увеличивается. Поэтому берём диапазон 500–1 000 RPS. Пиковое 2 000–3 000.

3. **Оформление заказа**  
   - В сутки: 8,8 млн заказов (по данным маркетплейса).  
   - Делим: 8 800 000 / 86 400 ≈ 102 RPS.  
   - С учётом округлений и неравномерной активности в разное время суток указываем ~100 RPS в среднем, и 2–3 кратное увеличение в пике.

4. **Добавление в корзину / избранное**  
   - Предположим, в день ~70% DAU делает 1–2 добавления: это 14 млн × 0,7 × (в среднем ~1,5 добавления) = ~14,7 млн действий.  
   - 14 700 000 / 86 400 ≈ 170 RPS. Но может быть выше за счёт «серфинга» (многие добавляют несколько товаров).  
   - Усреднённо указываем 300–500. Пиковое в 2–3 раза больше.

5. **Итого (примерно)**  
   - Складываем разные типы операций: 1 900–2 000 (просмотры) + 500–1 000 (поиск) + 100 (заказы) + 300–500 (корзина) ≈ 2 800–3 600 RPS.  
   - В период распродаж суммарная пиковая нагрузка может дойти до 7 000–10 000 RPS. В отдельных сервисах (например, поиск) бывают кратковременные всплески до сотен тысяч RPS, когда начинается массовый заход пользователей.


**Среднее количество запросов в секунду (RPS) рассчитывается по формуле:**  
> _RPS (Requests Per Second) = Общее количество операций в сутки / Количество секунд в сутках (86 400)._  


## 3. Глобальная балансировка нагрузки

Вот переработанная часть **3. Глобальная балансировка нагрузки** с учетом твоего запроса — один дата-центр в Москве, без изменения предыдущих частей. Стиль, структура и формат оформления полностью сохранены:

---

## 3. Глобальная балансировка нагрузки

### Функциональное разбиение по доменам

- **wildberries.ru** — API-сервисы для мобильных приложений и веб-версии.  
- **cdn.wildberries.ru** — доставка медиа-контента (фото товаров, видео, баннеры).  
- **wbxoofex.wildberries.ru** — сервис оформления заказов и управления корзиной.  
- **search.wb.ru** — отдельный домен для поиска товаров.  
- **seller.wildberries.ru** — платформа для продавцов.

---

### Расположение ДЦ

Wildberries использует централизованную архитектуру с одним дата-центром, расположенным в Москве. Это решение обеспечивает:

- Низкие задержки для основной аудитории (европейская часть России).
- Упрощение инфраструктуры и обслуживания.
- Централизацию бизнес-логики и хранения данных.

Для обеспечения отказоустойчивости в условиях единого ЦОД:

- Внутри московского дата-центра развернуты кластеры всех ключевых сервисов с горизонтальным масштабированием.
- Статические ресурсы (изображения, JS/CSS) кэшируются через CDN (расположенные ближе к пользователям).
- Критические данные регулярно бэкапятся в облако.

---

### Расчет распределения запросов

Поскольку используется только один дата-центр, весь трафик обрабатывается централизованно. Однако внутри дата-центра нагрузка распределяется по сервисам и их инстансам. Основные типы запросов:

1. **Просмотр каталога/карточек товара** — максимальный объем трафика.
2. **Поиск и фильтрация** — чувствительные к задержкам.
3. **Добавление в корзину/избранное** — частые AJAX-запросы.
4. **Оформление заказа** — критично к отказам и консистентности.

---

#### Таблица распределения RPS в централизованной архитектуре

| Тип запроса                | Средний RPS (общий) | Обработка (Москва, 100%) |
|----------------------------|---------------------|---------------------------|
| **Просмотр каталога**       | 1,900–2,000         | 1,900–2,000               |
| **Поиск/фильтрация**        | 500–1,000           | 500–1,000                 |
| **Оформление заказа**       | ~100                | ~100                      |
| **Добавление в корзину**    | 300–500             | 300–500                   |
| **Итого RPS**               | **2,800–3,600**     | **2,800–3,600**           |

---

1. **Просмотр каталога и поиск**:
   - Основная нагрузка на фронтенд и API-сервисы.
   - Раздается часть через CDN, остальное — из серверов приложений внутри московского дата-центра.

2. **Оформление заказов**:
   - Обрабатываются централизованно с высокой надежностью.
   - Данные синхронно записываются в отказоустойчивую кластерную БД.

3. **Добавление в корзину/избранное**:
   - Часто используемые запросы с минимальной нагрузкой на сеть и БД.
   - Быстро обрабатываются через API и in-memory кэш.

---

### Схема балансировки

При централизованной архитектуре балансировка реализуется внутри одного дата-центра в Москве с использованием нескольких уровней:

1. **DNS-резолвинг**:
   - Все домены `*.wildberries.ru` резолвятся на IP московского ЦОД.
   - Отказоустойчивость DNS реализована через кластер публичных DNS-серверов с коротким TTL (60–300 сек).

2. **Балансировка уровня L4 и L7**:
   - Входящий трафик поступает на кластер балансировщиков (например, HAProxy или NGINX Ingress).
   - Балансировщики направляют трафик на нужные микросервисы, согласно правилам маршрутизации (по URI, хосту, порту и т. д.).

3. **Кластеризация сервисов**:
   - Все сервисы масштабируются горизонтально.
   - Поддержка автоматического масштабирования при увеличении нагрузки (например, через Kubernetes HPA).
   - Кеширующие слои (Redis, Memcached) используются для снижения нагрузки на БД.

4. **CDN для статики**:
   - Изображения, видео и баннеры отдаются через CDN.
   - Это минимизирует нагрузку на ЦОД и ускоряет отдачу данных для пользователей из регионов.



## 4. Локальная балансировка нагрузки 

Конечно! Вот переработанная и сокращённая версия раздела **4. Локальная балансировка нагрузки**, оформленная в твоём стиле, с нужной ссылкой и пунктами, как в твоём примере:

---

## 4. Локальная балансировка нагрузки

### Описание архитектуры

В централизованной архитектуре Wildberries весь трафик обрабатывается в одном дата-центре в Москве. Входящие HTTPS-запросы поступают на кластер **L7-балансировщиков (Reverse Proxy)**, которые:

- завершают SSL/TLS-соединение (SSL termination),
- маршрутизируют запросы на микросервисы по URI/заголовкам (например, `/search`, `/cart`),
- кэшируют статический и полу-динамический контент,
- обеспечивают сжатие ответов и защиту от перегрузок (rate limiting, circuit breakers).

Балансировка осуществляется на уровне приложений (L7), что позволяет гибко управлять трафиком и равномерно распределять нагрузку между сервисами.

---

### Обоснование выбора балансировщика

Для Wildberries рассматриваются два варианта: **NGINX Open Source** и **NGINX Plus**.

**NGINX Open Source** — бесплатен, стабилен, высокопроизводителен. Однако не поддерживает активные health-check'и, динамическое управление конфигурацией и встроенный мониторинг.

**NGINX Plus** — коммерческая версия, обладающая:
- поддержкой от вендора (F5),
- встроенными метриками и дашбордом,
- session persistence и API для динамической настройки,
- активными health-check'ами.

Согласно [тесту производительности NGINX](https://blog.nginx.org/) [11], **один CPU-ядро может обрабатывать до ~28 000 новых HTTPS-запросов в секунду** в пессимистичном сценарии (без reuse соединений). На практике это даёт запас прочности и гибкость масштабирования. С учётом масштабов Wildberries и критичности к бесперебойной работе, **выбор в пользу NGINX Plus оправдан**: он позволяет снизить операционные риски и упростить сопровождение кластера.

---

### Расчёт нагрузки и CPU

#### Исходные данные:
- Пиковый RPS: **10 000**
- Размер запроса: ~10 КБ
- Предположения: каждый запрос — новое соединение, нет reuse
- Производительность по [11]:  
  - **NGINX OSS**: ~700 HTTPS-соединений/с на 1 ядро  
  - **NGINX Plus**: ~800 HTTPS-соединений/с на 1 ядро

---

#### Таблица расчета CPU и трафика

| Балансировщик     | RPS     | Трафик (Мбит/с) | CPU, мс/с | Необходимые ядра |
|-------------------|---------|------------------|------------|-------------------|
| **NGINX OSS**     | 10 000  | ~800             | ~14 300     | ~15–16 ядер       |
| **NGINX Plus**    | 10 000  | ~800             | ~12 500     | ~13–14 ядер       |

> Пример: 1 ядро = 1 000 мс CPU/сек.  
> С учетом резерва и возможности масштабирования на практике используют 2+ балансировщика (Active/Active или Active/Passive) по 8–16 vCPU каждый.

---

### Применение в Wildberries

- **Просмотр каталога**: кэширование изображений и статики снижает нагрузку.
- **Поиск/фильтрация**: направляется на отдельный кластер поиска.
- **Оформление заказа**: прокси проверяет доступность бэкендов (CRM, платежи) и переключается при сбое.
- **Рекомендации и авторизация**: маршрутизация по cookie или URI на нужный сервис.

---

### Заключение

Для централизованной архитектуры с пиковым RPS до 10 000, Wildberries использует **L7-балансировку через NGINX Plus**, как более надёжное, управляемое и масштабируемое решение. Балансировка выполняет не только распределение трафика, но и SSL termination, кэширование и управление отказоустойчивостью сервисов. Это снижает задержки, увеличивает стабильность и упрощает эксплуатацию всей платформы.


## 5. Логическая схема БД
https://dbdiagram.io/d/DB-67d834af75d75cc844632f37

![DB](https://github.com/user-attachments/assets/650f27fb-de5f-47cf-ab38-371a2d556678)


---

### 1. Описанием таблиц и основных полей

| **Название таблицы**     | **Назначение**                                                                                                                                                | **Основные поля**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | **Связи**                                                                                                                                                           |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **users**                | Хранение информации о пользователях (как покупателях, так и продавцах, администраторах и т.д.).                                                              | - **id** (PK) – уникальный идентификатор<br>- **name** – имя пользователя<br>- **email** – адрес электронной почты<br>- **password** – пароль (хранить в виде хеша)<br>- **user_type** – тип пользователя (buyer, seller, admin)<br>- **region**, **geolocation** – локационные данные для персонализации и доставки<br>- **created_at**, **updated_at** – даты создания и обновления записи                                                                                | - Связь «1 ко многим» с таблицей **products** (seller_id → users.id)<br>- Связь «1 ко многим» с **carts** (user_id → users.id)<br>- Связь «1 ко многим» с **orders** (user_id → users.id)                   |
| **products**             | Каталог товаров, включая название, описание, цену, привязку к продавцу и т.д.                                                                                 | - **id** (PK) – уникальный идентификатор<br>- **seller_id** (FK на **users**.id) – продавец<br>- **name** – название<br>- **description** – описание<br>- **price** – цена<br>- **brand** – бренд (для фильтрации)<br>- **image_url** – ссылка на изображение (или несколько полей/таблиц для хранения мультимедиа)<br>- **created_at**, **updated_at** – даты создания и обновления                                                                                                      | - Связь «многие к одному» с **users** (seller_id)<br>- Связь «многие ко многим» с **categories** через **product_categories**<br>- Связь «1 ко многим» с **views** (product_id) |
| **categories**           | Справочник категорий товаров (дерево категорий или плоский список).                                                                                           | - **id** (PK) – уникальный идентификатор<br>- **name** – наименование категории<br>- **parent_id** (FK на **categories**.id) – для иерархической структуры категорий (при необходимости)                                                                                                                                                                                                                                                                                                      | - Связь «многие к одному» саму с собой (parent_id → categories.id)<br>- Через **product_categories** связывается с **products**                                                                           |
| **product_categories**   | Таблица-связка «многие ко многим» между товарами и категориями.                                                                                              | - **product_id** (FK на **products**.id)<br>- **category_id** (FK на **categories**.id)<br>- PK по паре (product_id, category_id)                                                                                                                                                                                                                                                                                                                                                              | - Связь «многие ко многим» между **products** и **categories**                                                                                                       |
| **favorites**            | Хранение «избранного» для каждого покупателя (список товаров, которые пользователь добавил в избранное).                                                     | - **user_id** (FK на **users**.id)<br>- **product_id** (FK на **products**.id)<br>- **created_at**<br>- PK по паре (user_id, product_id)                                                                                                                                                                                                                                                                                                                                                       | - Связь «многие ко многим» (через отдельную таблицу) между **users** и **products**, но в данном случае PK = (user_id, product_id)                                                                         |
| **views**                | Учет просмотренных товаров пользователем (для рекомендаций и аналитики).                                                                                     | - **id** (PK) – уникальный идентификатор<br>- **user_id** (FK на **users**.id)<br>- **product_id** (FK на **products**.id)<br>- **viewed_at** – дата/время просмотра                                                                                                                                                                                                                                                                                                                           | - Связь «многие ко многим» (фактически через дополнительную информацию) между **users** и **products**, но реализуется как «1 ко многим» для каждой из сторон         |
| **search_queries**       | Хранение истории поисковых запросов пользователей (для рекомендаций и анализа популярности товаров).                                                          | - **id** (PK) – уникальный идентификатор<br>- **user_id** (FK на **users**.id)<br>- **query** – текст поискового запроса<br>- **created_at** – дата/время запроса                                                                                                                                                                                                                                                                                                                             | - Связь «многие ко многим» (через дополнительную информацию) между **users** и поисковым контентом (сам запрос)                                                      |
| **carts**                | Корзина товаров для каждого пользователя (активная корзина до оформления заказа).                                                                             | - **id** (PK) – уникальный идентификатор<br>- **user_id** (FK на **users**.id)<br>- **created_at**, **updated_at**                                                                                                                                                                                                                                                                                                                                                                            | - Связь «1 ко многим» (user_id → users.id)<br>- Связь «1 ко многим» с **cart_items**                                                                                |
| **cart_items**           | Содержимое корзины (товары и их количество).                                                                                                                  | - **id** (PK) – уникальный идентификатор<br>- **cart_id** (FK на **carts**.id)<br>- **product_id** (FK на **products**.id)<br>- **quantity**<br>- **created_at**, **updated_at**                                                                                                                                                                                                                                                                                                             | - Связь «многие к одному» с **carts** и **products**                                                                                                                |
| **orders**               | Оформленные заказы пользователей.                                                                                                                             | - **id** (PK) – уникальный идентификатор<br>- **user_id** (FK на **users**.id)<br>- **order_date**<br>- **status** – статус заказа (напр. «Новый», «Оплачен», «Доставляется», «Завершен», «Отменен») <br>- **payment_method**<br>- **shipping_method**<br>- **shipping_address**, **shipping_city**, **shipping_region**, **shipping_postal_code**<br>- **total_amount**<br>- **created_at**, **updated_at**                                                                                                           | - Связь «1 ко многим» (user_id → users.id)<br>- Связь «1 ко многим» с **order_items** (order_id → orders.id)<br>- Связь «1 к 1» или «1 ко многим» с **payments** и **shipment_tracking**                    |
| **order_items**          | Перечень товаров в заказе (в т.ч. количество и цена на момент оформления).                                                                                   | - **id** (PK) – уникальный идентификатор<br>- **order_id** (FK на **orders**.id)<br>- **product_id** (FK на **products**.id)<br>- **quantity**<br>- **unit_price**, **total_price**<br>- **created_at**, **updated_at**                                                                                                                                                                                                                                                                       | - Связь «многие к одному» (order_id → orders.id), (product_id → products.id)                                                                                        |
| **payments**             | Информация об оплатах (для одного заказа может быть несколько платежей или один платеж).                                                                     | - **id** (PK) – уникальный идентификатор<br>- **order_id** (FK на **orders**.id)<br>- **amount**<br>- **payment_date**<br>- **status** (напр. «Проведён», «Отклонён», «В обработке»)<br>- **payment_method** – какой сервис/метод оплаты<br>- **transaction_id**<br>- **created_at**, **updated_at**                                                                                                                                                                                        | - Связь «многие к одному» (order_id → orders.id)                                                                                                                    |
| **shipment_tracking**    | Данные для отслеживания доставки (трек-номер и статус посылки).                                                                                              | - **id** (PK) – уникальный идентификатор<br>- **order_id** (FK на **orders**.id)<br>- **tracking_number**<br>- **status**<br>- **updated_at**                                                                                                                                                                                                                                                                                                                                                 | - Связь «1 ко многим» (order_id → orders.id)                                                                                                                       |


# Размер таблиц и объём данных


| Таблица           | Размер строки (байт) | Пояснение                                                                                 | Кол-во строк (оценка)      | Общий размер таблицы  |
|-------------------|----------------------|-------------------------------------------------------------------------------------------|---------------------------:|-----------------------|
| **Users** (пользователи)       | ~150              | `user_id` (INT, 4 байта), имя (VARCHAR, ~30 байт), email/телефон (VARCHAR, ~30 байт), хэш пароля (VARCHAR, ~60 байт), дата регистрации (TIMESTAMP, 8 байт). Примерно 130 байт данных + запас на служебные поля/выравнивание. | ~76 700 000  (≈76,7 млн MAU)  | ~11 000 МБ (≈11 ГБ)    |
| **Products** (товары/SKU)     | ~250              | `product_id` (INT, 4 байта), название товара (VARCHAR, ~50 байт), категория (SMALLINT, 2 байта), продавец (INT, 4 байта), цена (DECIMAL/FLOAT, 8 байт), описание (TEXT, ~200 байт среднее). Около 268 байт на запись, округлено. | ~40 000 000               | ~10 000 МБ (≈10 ГБ)    |
| **Categories** (категории)    | ~50               | `category_id` (SMALLINT, 2 байта), название категории (VARCHAR, ~20 байт), родительская категория (SMALLINT, 2 байта). Небольшой набор полей для иерархии каталога. | ~5 000                    | <0.01 ГБ (≈0.003 ГБ)   |
| **Carts** (корзины)          | ~16               | `cart_id` (INT, 4 байта, соответствует пользователю), дата обновления (TIMESTAMP, 8 байт). Хранит текущую активную корзину каждого пользователя. | ~80 000 000               | ~1 200 МБ (≈1.2 ГБ)    |
| **Cart_items** (позиции в корзинах) | ~16       | `cart_id` (INT, 4 байта), `product_id` (INT, 4 байта), количество (INT, 4 байта). Каждая запись представляет товар в корзине и его количество. | ~100 000 000              | ~1 600 МБ (≈1.6 ГБ)    |
| **Orders** (заказы)         | ~50               | `order_id` (BIGINT, 8 байт), `user_id` (INT, 4 байта), дата заказа (TIMESTAMP, 8 байт), статус (TINYINT, 1 байт), сумма итого (DECIMAL, 8 байт). Минимальный набор данных по заказу (адрес доставки хранится отдельно). | ~3 200 000 000 (≈3,2 млрд) | ~160 000 МБ (≈160 ГБ)  |
| **Order_items** (товары в заказах) | ~24       | `order_id` (BIGINT, 8 байт), `product_id` (INT, 4 байта), количество (INT, 4 байта), цена товара (DECIMAL, 8 байт). Строка на каждый товар, проданный в рамках заказа. | ~6 400 000 000 (≈6,4 млрд) | ~300 000 МБ (≈300 ГБ)  |
| **Payments** (платежи)       | ~32               | `payment_id` (BIGINT, 8 байт), `order_id` (BIGINT, 8 байт), метод оплаты (TINYINT, 1 байт), статус оплаты (TINYINT, 1 байт), сумма (DECIMAL, 8 байт), транзакция/квитанция (VARCHAR, ~20 байт). | ~3 200 000 000 (≈3,2 млрд) | ~100 000 МБ (≈100 ГБ)  |
| **Shipment_tracking** (отгрузки) | ~40        | `order_id` (BIGINT, 8 байт), трек-номер посылки (VARCHAR, ~20 байт), статус доставки (TINYINT, 1 байт), последний апдейт/дата доставки (TIMESTAMP, 8 байт). | ~3 200 000 000 (≈3,2 млрд) | ~130 000 МБ (≈130 ГБ)  |

*Примечание:* Оценочное число строк для таблиц **Orders**, **Order_items**, **Payments** и **Shipment_tracking** рассчитывалось исходя из ~8,8 млн заказов в день. Это соответствует приблизительно 3,2 млрд заказов в год, которые хранятся в базе (без учёта архивирования старых данных). **Order_items** предположительно в ~2 раза больше количества заказов, исходя из среднего ~2 товаров на заказ. Для **Payments** и **Shipment_tracking** считается по одному записанному платежу и отправлению на каждый заказ (в реальности возможно более одного отправления на заказ, но для упрощения принят 1:1). 

Таблица **Users** основана на показателе ~76,7 млн уникальных активных пользователей в месяц (MAU), что задаёт порядок величины зарегистрированных аккаунтов. **Products** отражает ассортимент ~40 млн SKU (уникальных товаров/предложений) на площадке. **Categories** включает несколько тысяч категорий и подкатегорий товаров – объём этой таблицы незначителен по сравнению с другими. 

В **Carts** хранится по одной актуальной корзине на пользователя; мы предполагаем порядка десятков миллионов активных корзин. **Cart_items** содержит записи товаров, добавленных в корзины; оценка (~100 млн строк) основана на допущении, что не все пользователи имеют наполненную корзину одновременно (в среднем 1–2 товара в активной корзине пользователя). 

Размер одной строки в каждой таблице рассчитан по типам полей: числовые идентификаторы (INT, BIGINT) занимают 4–8 байт, UUID при использовании занял бы 16 байт на значение, короткие числовые статусы – 1 байт, даты/время – 8 байт, строки переменной длины (VARCHAR/TEXT) оценивались по средней длине в байтах. Общий объём таблиц в основном определяется количеством записей: например, таблицы заказов и связанных с ними данных достигают масштаба сотен гигабайт, тогда как справочные таблицы (категории и т.п.) занимают незначительное пространство.


### Размеры данных и нагрузки на чтение/запись

Ниже приведена **сводная таблица** по нагрузке на чтение и запись (RPS — запросы в секунду) для каждой ключевой таблицы, исходя из общего распределения действий пользователей (просмотры, поиск, оформление заказов, добавление в корзину и т.д.). 


---

## Размеры данных и нагрузки на чтение/запись

В таблице:

1. **Row Size (bytes)** – усреднённый размер одной строки (включая типичные поля).  
2. **Read RPS / Write RPS** – приблизительный диапазон запросов в секунду.  
3. **Rows per read / write** – сколько строк в среднем участвует в одном запросе.  
4. **Rows read/s или write/s** = (RPS × Rows per req).  
5. **Data read/s (bytes/s)** = (Rows read/s) × (Row Size). 


| **Таблица**          | **Row<br>Size (bytes)** | **Read<br>RPS**       | **Rows<br>per read** | **Rows<br>read/s**               | **Data<br>read/s (bytes/s)**                        | **Write<br>RPS**  | **Rows<br>per write** | **Rows<br>write/s**             | **Data<br>write/s (bytes/s)**                     | **Комментарий**                                                                                                        |
|----------------------|:-----------------------:|:---------------------:|:--------------------:|:--------------------------------:|:----------------------------------------------------:|:-----------------:|:---------------------:|:--------------------------------:|:--------------------------------------------------:|:-----------------------------------------------------------------------------------------------------------------------|
| **users**            | ~1 024                 | 50–100               | 1                   | 50–100                            | 50–100 × 1 024 ≈ 51 200–102 400 <br>(≈ 50–100 KB/s)   | 2–5               | 1                     | 2–5                               | 2–5 × 1 024 ≈ 2 048–5 120 <br>(≈ 2–5 KB/s)         | Чтение при авторизации, просмотре профиля; запись реже (регистрация, обновление)                                         |
| **products**         | ~2 048                 | 1 500–2 000          | ~10                 | 15 000–20 000                     | 15 000–20 000 × 2 048 <br>≈ 30,7–41 млн байт/с <br>(≈ 30–40 MB/s) | 50–80            | 1                     | 50–80                            | 50–80 × 2 048 = 102 400–163 840 <br>(≈ 0,1–0,16 MB/s) | Наиболее часто читаемая таблица (каталог товаров). Часть отдаётся из кэша (Redis, CDN), что уменьшает реальную нагрузку    |
| **categories**       | ~512                   | 300–500              | ~20                 | 6 000–10 000                      | 6 000–10 000 × 512 <br>≈ 3 072 000–5 120 000 <br>(≈ 3–5 MB/s)      | 1–2              | 1                     | 1–2                              | 512–1 024 <br>(~0,5–1 KB/s)                      | Чтение для структуры категорий. Запись редка (админ добавляет/правит категории)                                           |
| **product_categories** | ~307                 | 300–500              | ~30                 | 9 000–15 000                      | 9 000–15 000 × 307 ≈ 2 763 000–4 605 000 <br>(≈ 2,7–4,6 MB/s)       | 10–20            | ~2                    | 20–40                           | 20–40 × 307 ≈ 6 140–12 280 <br>(6–12 KB/s)         | Связка «товар–категория». Активно читается при фильтрации/поиске                                                           |
| **favorites**        | ~307                  | 100–200             | 1                   | 100–200                           | 30 700–61 400 <br>(30–60 KB/s)                       | 50–100           | 1                     | 50–100                           | 15 350–30 700 <br>(15–30 KB/s)                    | Пользовательские избранные товары. «Добавить/удалить из избранного»                                                       |
| **views**            | ~512                  | 10–50               | ~10                 | 100–500                           | 100–500 × 512 = 51 200–256 000 <br>(≈ 0,05–0,25 MB/s) | 400–600          | 1                     | 400–600                          | 400–600 × 512 = 204 800–307 200 <br>(≈ 0,2–0,3 MB/s) | Лог просмотров (высокий объём записи). В реальности часто уходит во внешнее аналитическое хранилище (ClickHouse и т.д.)     |
| **search_queries**   | ~512                  | 5–10                | 1                   | 5–10                              | 2 560–5 120 <br>(≈ 2,5–5 KB/s)                      | 100–200          | 1                     | 100–200                          | 51 200–102 400 <br>(≈ 50–100 KB/s)                | Лог поисковых запросов (высокий write, редко читают онлайн). Обычно анализируют отдельно                                    |
| **carts**            | ~512                  | 200–300             | 1                   | 200–300                           | 102 400–153 600 <br>(≈ 0,1–0,15 MB/s)                | 150–200          | 1                     | 150–200                          | 76 800–102 400 <br>(≈ 0,07–0,1 MB/s)              | Описание корзины (ID, пользователь, таймстемп). «cart_items» хранит детали товаров                                         |
| **cart_items**       | ~512                  | 200–300             | ~5                  | 1 000–1 500                       | 512 000–768 000 <br>(≈ 0,5–0,75 MB/s)                | 150–200          | 1                     | 150–200                          | 76 800–102 400 <br>(≈ 0,07–0,1 MB/s)              | Позиции в корзине: при чтении часто выбирают сразу несколько строк                                                         |
| **orders**           | ~1 024               | 50–100             | ~3                  | 150–300                           | 153 600–307 200 <br>(≈ 0,15–0,3 MB/s)                | ~100             | 1                     | ~100                             | 100 × 1 024 = 102 400 <br>(≈ 0,1 MB/s)            | Запись при создании нового заказа; чтение при просмотре истории                                                             |
| **order_items**      | ~512                  | 50–100             | ~5                  | 250–500                           | 128 000–256 000 <br>(≈ 0,12–0,25 MB/s)               | ~100             | ~3                    | 300                              | 300 × 512 = 153 600 <br>(≈ 0,15 MB/s)             | В одном заказе обычно несколько позиций                                                                                    |
| **payments**         | ~512                  | 20–30              | 1                   | 20–30                             | 10 240–15 360 <br>(≈ 0,01–0,015 MB/s)                | 50–80            | 1                     | 50–80                            | 25 600–40 960 <br>(≈ 0,025–0,04 MB/s)             | Фиксация платежа и проверка статуса                                                                                        |
| **shipment_tracking**| ~512                  | 20–30              | 1                   | 20–30                             | 10 240–15 360 <br>(≈ 0,01–0,015 MB/s)                | 10–20            | 1                     | 10–20                            | 5 120–10 240 <br>(≈ 0,005–0,01 MB/s)             | Отслеживание посылок: в основном чтение; запись статусов реже                                                               |

---

- При **суммарном RPS** (просмотры, корзина, поиск, оформление и т.д.) ~2 800–3 600 в среднем (и до 7 000–10 000 в пике) **далеко не все** запросы доходят до каждой таблицы.  
- Часть запросов — кэшированные данные (CDN статика, redis-cache и т.д.), часть — вообще не идут в SQL-базу.
- Поэтому реальные RPS на каждую таблицу оказываются ниже, чем суммарный RPS на уровень веб-сервиса.


### Требования к консистентности

1. **ACID-транзакции**  
   - Для оформления заказов, списания платежей и т.д. необходима полная гарантия целостности (Atomicity, Consistency, Isolation, Durability).  

---

### Особенности распределения нагрузки по ключам

При масштабировании и большом объёме данных возникают вопросы **шардирования** и **репликации**:

- **Горизонтальное шардирование по пользователям (user_id)**  
  - Таблицы, сильно зависящие от пользователя: `carts`, `views`, `search_queries`, `favorites` и др., можно партиционировать или шардировать по `user_id`.  
  - Это распределяет нагрузку на чтение/запись по нескольким узлам, так как запросы, связанные с одним пользователем, будут попадать на конкретный шард.

- **Партиционирование по дате**  
  - Для «логов» (например, `views`, `search_queries`) часто используют **партиционирование по времени** (партиции по месяцам/неделям). Устаревшие данные можно либо архивировать, либо хранить в менее дорогом хранилище.  

- **Репликация**  
  - Для повышения отказоустойчивости и скорости чтения (особенно запросов, связанных с просмотром каталога, поиском товаров и т.п.) используют реплики. Основной узел (Primary) отвечает за запись, а чтение масштабируется за счёт Replica-нод.

### 6. Физическая схема БД

### 6.1. Схема БД
https://dbdiagram.io/d/DB-67d834af75d75cc844632f37
![DB2](https://github.com/user-attachments/assets/67d8902e-5a5c-458f-ab02-c2c8363f6565)



![image](https://github.com/user-attachments/assets/4f10bb00-c146-4f4d-ad87-03f9751ae059)


## 6.2. Пояснения

### 6.2.1. Таблица с описанием (структурой) основных таблиц

| **Таблица**            | **Назначение**                                                          | **Основные поля**                                                                                                                                                                         | **Ключи и индексы**                                                                                                      |
|------------------------|--------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------|
| **users**              | Сведения о пользователях (покупатели, продавцы, админы).                 | `id PK`, `name`, `email`, `password`, `user_type`, `region`, `geolocation`, `created_at`, `updated_at`                                                                                     | - PK: `id`<br>- Unique Index: `email`<br>- Индекс по `region` (для сегментации, персонализации)                           |
| **products**           | Справочник товаров.                                                      | `id PK`, `seller_id (FK)`, `name`, `description`, `price`, `brand`, `image_url`, `created_at`, `updated_at`                                                                               | - PK: `id`<br>- Индексы: `seller_id`, `price`, `brand`                                                                    |
| **categories**         | Категории товаров (иерархия).                                           | `id PK`, `name`, `parent_id (FK -> self)`.                                                                                                                                                | - PK: `id`<br>- Индекс: `parent_id`<br>- Возможна материализация дерева, если нужно быстрый выбор всех «детей»            |
| **product_categories** | Связка многие-к-многим «товар – категория».                              | `product_id (FK), category_id (FK)`                                                                                                                                                       | - Составной PK: (`product_id`, `category_id`)                                                                             |
| **favorites**          | «Избранные» товары покупателя.                                           | `user_id (FK), product_id (FK), created_at`                                                                                                                                                | - Составной PK: (`user_id`, `product_id`)                                                                                |
| **views**              | Лог просмотров товаров пользователями (для аналитики, рекомендаций).     | `id PK, user_id (FK), product_id (FK), viewed_at`                                                                                                                                         | - Индексы: `user_id`, `product_id`<br>- Часто партиционируется по `viewed_at`                                                                                   |
| **search_queries**     | Лог поисковых запросов.                                                 | `id PK, user_id (FK), query, created_at`                                                                                                                                                  | - Индексы: `user_id`, `created_at`<br>- Партиционирование по датам для аналитики                                                                                |
| **carts**              | «Корзина» пользователя (головная часть корзины).                         | `id PK, user_id (FK), created_at, updated_at`                                                                                                                                             | - Индекс: `user_id`                                                                                                       |
| **cart_items**         | Позиции товаров в корзине.                                              | `id PK, cart_id (FK), product_id (FK), quantity, created_at, updated_at`                                                                                                                  | - Индексы: `cart_id`, `product_id`                                                                                       |
| **orders**             | Оформленные заказы.                                                      | `id PK, user_id (FK), order_date, status, payment_method, shipping_method, ... total_amount, created_at, updated_at`                                                                       | - Индексы: `user_id`, `status`, `order_date`                                                                              |
| **order_items**        | Товары в составе заказа (дублируют цену, количество на момент покупки).  | `id PK, order_id (FK), product_id (FK), quantity, unit_price, total_price, created_at, updated_at`                                                                                        | - Индексы: `order_id`, `product_id`                                                                                      |
| **payments**           | Информация об оплатах (в одном заказе может быть несколько платежей).    | `id PK, order_id (FK), amount, payment_date, status, payment_method, transaction_id, created_at, updated_at`                                                                               | - Индексы: `order_id`, `status`                                                                                           |
| **shipment_tracking**  | Информация об отслеживании доставки.                                     | `id PK, order_id (FK), tracking_number, status, updated_at`                                                                                                                               | - Индекс: `order_id`                                                                                                      |

---

### 6.2.2. Индексы

В каждой таблице предусмотрены следующие основные индексы:

1. **Первичные ключи (Primary Key)**:
   - `id` (PK) в большинстве таблиц (или составной PK для таблиц-связок).
2. **Уникальные индексы**:
   - `users(email)`, чтобы исключить дублирование e-mail.
3. **Внешние ключи (FK)**:
   - Например, `seller_id -> users.id` в `products`, `user_id -> users.id` в `favorites`, и т. п.
4. **Частые индексы для фильтрации**:
   - `price` и/или `brand` в таблице `products` (при выдаче каталога).
   - `status` в `orders` или `payments`.
   - `created_at` в логирующих таблицах, чтобы быстро находить записи за нужный период.
5. **Составные индексы** (при необходимости, например `(status, order_date)`), если часто фильтруем по статусу и дате одновременно.  
   В dbdiagram.io их можно отметить комментарием.

**Обоснование**: индексы формируются исходя из частых сценариев чтения/записи и фильтрации (WHERE user_id = ?; WHERE brand = ?; WHERE date between ? and ? и т.д.).

---

### 6.2.3. Денормализация

Денормализация может потребоваться для ускорения выборок и снижения количества JOIN:

1. **Копирование «названия категории» в `products`**  
   Если часто требуется выводить название категории без дополнительного JOIN, можно хранить **дублированное** поле `category_name` (или целый массив категорий) в `products`. Но это усложняет синхронизацию при изменении категорий.

2. **Предрасчитанные итоги/статистика**  
   - Например, чтобы в «личном кабинете продавца» быстро показывать число заказов, можно в отдельной таблице (или в Redis-кэше) вести агрегаты (итоги по продажам, остаткам и т.п.).  
   - Для аналитики просмотров, заказов, поисковых запросов обычно создаются **материализованные представления** или **отдельные витрины** данных в системах BigData (ClickHouse, Hadoop, т.д.).

3. **Кэширование часто запрашиваемых данных**  
   - Кэш в Redis (либо Memcached) для самых горячих запросов («ТОП-товары», «последние просмотренные»).  
   - CDN для раздачи статики (изображения, CSS/JS).

> **Принцип**: максимальную нормализацию используем в транзакционных таблицах (orders, payments). Денормализация — для ускорения чтения в высоконагруженных сервисах (каталог, аналитика).

---

### 6.2.4. Выбор СУБД (потаблично)

Современные маркетплейсы используют **гибридный подход**:

| **Таблица / Данные**            | **Типичные требования**                                   | **Рекомендуемая СУБД**                                                           | **Комментарий**                                                                                          |
|---------------------------------|------------------------------------------------------------|-----------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------|
| **users**, **orders**, **payments**, **products**, **carts** … | Транзакционные операции, ACID, гарантия целостности.       | **Реляционная СУБД (PostgreSQL / MySQL / Oracle)**                       | Оптимально хранить в одной транзакционной БД для атомарности и связей.                                    |
| **views**, **search_queries**   | Огромные объёмы логов, аналитика, быстрые вставки, партиции | **ClickHouse**, **Hive**, **BigQuery** или др. аналитические/колоночные хранилища | В оперативной системе можно держать «последние X дней» для быстрых рекомендаций, остальное — в DWH.       |
| **categories**, **product_categories** | Справочники, дерево категорий                            | **Та же реляционная СУБД** (для удобства JOIN)                                  | Небольшие объёмы данных; удобно хранить в PostgreSQL/MySQL вместе с основными данными.                    |
| **Поисковый индекс**            | Полнотекстовый поиск, ранжирование, поиск по описанию       | **Elasticsearch**, **OpenSearch** (или Sphinx, SOLR и т.д.)                    | Используется как дополнительный поиск; обновляется из транзакционной БД.                                  |
| **Статические файлы** (изображения товаров) | Большие бинарные объёмы                                  | **Object Storage** (S3-совместимые, MinIO и т.п.)                               | В самой БД хранить только метаданные (URL). Основной объём — в отдельном файловом/объектном хранилище.     |

> **Основная Транзакционная БД**: PostgreSQL (или MySQL).  
> **Логи и аналитика**: ClickHouse / BigQuery / Snowflake.  
> **Поисковый движок**: Elasticsearch / OpenSearch.  
> **Хранилище изображений**: S3-совместимое, CDN для раздачи.


---

### 6.2.5. Шардирование и резервирование (репликация) СУБД

#### Шардирование

1. **Шардирование по пользователям (user_id)**  
   - Таблицы, связанные с активностью пользователя: `views`, `favorites`, `search_queries`, `carts`, а также часть `orders` (хотя у заказов обычно глобальные айди).  
   - Можно завести **N шард** (postgresql instances), распределяя пользователей по диапазонам user_id или по хешу (user_id mod N).  
   - Достоинство: обращения к одному пользователю сосредоточены на одном шарде.  
   - Недостаток: требуется распределённая логика при запросах глобальной аналитики.

2. **Партиционирование по дате** (или по датам + user_id)  
   - Большие лог-таблицы (`views`, `search_queries`) — дробим по временным интервалам (партиции по месяцу/неделе).  
   - Упрощает очистку (retention) и ускоряет запросы по недавним данным.

#### Репликация

- **Master-Slave (Primary-Replica)**:  
  - Master/Primary обрабатывает запись (INSERT/UPDATE), реплики синхронизируются асинхронно или синхронно.  
  - Чтение (SELECT) может идти на реплики для разгрузки мастера.
- **Геораспределённая репликация** для отказоустойчивости (если основной ЦОД вышел из строя).  
- **СУБД для аналитики** (ClickHouse и др.) может получать данные через **стриминг/ETL** в near real-time.

> Для транзакционной БД (PostgreSQL) обычно настраивают пару-тройку реплик (по географии), а для логов используют отказоустойчивый кластер ClickHouse.

---

### 6.2.6. Клиентские библиотеки / интеграции

- **Транзакционная СУБД**: драйверы PostgreSQL (например, `libpq`, `pgJDBC`, `Npgsql` для .NET, `psycopg2` для Python).  
- **Поисковый движок**: интеграция через REST API Elasticsearch или клиентские библиотеки. Синхронизация (ETL) из основной БД.  
- **Аналитическая БД**: коннекторы и утилиты (например, Kafka + ClickHouse, Debezium для CDC).  
- **Object Storage (S3)**: через HTTP/S3-протокол (AWS SDK, MinIO client, etc.).  
- **Redis**: для кеширования и быстрой выдачи самых популярных запросов.

---

### 6.2.7. Балансировка запросов / мультиплексирование подключений

1. **Connection Pooling**:
   - Использование PgBouncer (для PostgreSQL) или ProxySQL (MySQL) для управления пулом соединений.  
   - Сокращает overhead при установке множества коротких соединений.
2. **Load Balancing**:
   - Запросы на чтение отправляем на реплики.  
   - Пишущие запросы (INSERT/UPDATE) — на Primary.
3. **API-шлюзы** или **Reverse Proxy** (Nginx, HAProxy) на уровне веб-приложения — для маршрутизации и распределения нагрузки.
4. **Микросервисная архитектура**:  
   - Сервисы поиска идут в Elasticsearch,  
   - Сервис заказов — в транзакционную БД,  
   - Сервис аналитики — в ClickHouse.  
   Логика разделяется, а запросы балансируются по разным кластерам.

---

### 6.2.8. Схема резервного копирования

Для **транзакционной PostgreSQL**:

1. **Ежедневный полный бэкап** (physical backup) на ночь (pg_basebackup).  
2. **WAL-логирование** (архивирование WAL) в режиме point-in-time recovery. Позволяет восстанавливать БД до конкретного момента.  
3. **Еженедельная проверка восстановлений** для убедительности.

Для **больших лог-таблиц** (ClickHouse и т.п.):

- Хранятся реплики на нескольких узлах (distributed replication).  
- Партиции за старые даты можно архивировать во внешний storage (S3).  
- Возможен вариант «основные данные – в кластере, старше года – в Glacier / холодном хранилище».

Для **объектного хранилища** (S3):

- Версионирование (versioning) включено, копии в разных зонах доступности.  
- Регулярные копии на «deep archive» при необходимости.

## Список источников

1. [Wildberries — ruwiki](https://ru.ruwiki.ru/wiki/Wildberries)  
2. [SimilarWeb: Wildberries (overview)](https://www.similarweb.com/ru/website/wildberries.ru/#overview)  
3. [CMP Wildberries (Special project kit) — аудитория, статистика](https://cmp.wildberries.ru/cmpf/Special%20project%20kit%20WB.pdf)  
4. [Retail.ru: Оборот Wildberries, 14 млн посетителей в день](https://www.retail.ru/news/oborot-wildberries-vyros-na-101-v-iii-kvartale-15-oktyabrya-2021-210183/)  
5. [Data Insight — Sellers Monitoring 2024 (40 млн SKU)](https://datainsight.ru/sites/default/files/DI_Sellers_monitoring_2024_1_0.pdf?ysclid=m7px4bgk8r609130117)  
6. [Plusworld: Средняя цена и средний чек на маркетплейсах](https://plusworld.ru/articles/62655/#:~:text=%D0%A1%D1%80%D0%B5%D0%B4%D0%BD%D1%8F%D1%8F%20%D1%86%D0%B5%D0%BD%D0%B0%20%D0%BD%D0%B0%20%D0%BC%D0%B0%D1%80%D0%BA%D0%B5%D1%82%D0%BF%D0%BB%D0%B5%D0%B9%D1%81%D0%B5)  
7. [Mertech.ru: 8,8 млн заказов Wildberries в сутки](https://mertech.ru/blog/marketpleisy/kak-otkryt-punkt-vydachi-zakazov-wildberries-v-2024/#:~:text=Wildberries%20%E2%80%94%20%D1%81%D0%B0%D0%BC%D1%8B%D0%B9%20%D1%80%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%B8%D0%B9)  
8. [HTTP Archive: Статистика «веса» страницы](https://httparchive.org/reports/page-weight)  
9. [Workspace.ru](https://workspace.ru/blog/algoritmy-ranzhirovaniya-na-wildberries-kak-oni-rabotayut-i-kak-uluchshit-vidimost-svoih-tovarov/)
10. https://www.cloudflare.com/learning/performance/why-site-speed-matters/
